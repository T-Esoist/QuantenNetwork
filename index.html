<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>T-ESOIST | Auto-Injection</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { background: #000; color: #00f2ff; font-family: monospace; padding: 15px; text-align: center; }
        .injection-unit { border: 2px solid #00f2ff; padding: 20px; border-radius: 15px; background: #050505; box-shadow: 0 0 30px #00f2ff; }
        .data-field { width: 100%; background: #111; border: 1px solid #333; color: #00ff00; padding: 10px; margin: 5px 0; font-size: 12px; }
        .btn-inject { width: 100%; background: #00f2ff; color: #000; border: none; padding: 20px; font-weight: bold; border-radius: 10px; cursor: pointer; margin-top: 15px; }
        .status-led { height: 10px; width: 10px; border-radius: 50%; display: inline-block; background: #ff0055; margin-right: 5px; }
        .online { background: #00ff00; box-shadow: 0 0 10px #00ff00; }
    </style>
</head>
<body>
    <div class="injection-unit">
        <h3>AUTO-INJECTION v98</h3>
        <div style="margin-bottom: 10px;"><span id="led" class="status-led"></span> <small>LINK STATUS: READY</small></div>
        
        <input type="text" class="data-field" value="ID: Ω-19D4-50A8-MARC" readonly>
        <input type="text" class="data-field" id="current-val" placeholder="BETRAG WARTET AUF INJEKTION..." readonly>
        
        <button class="btn-inject" onclick="document.getElementById('gate').click()">1. STORE-KONTAKT HERSTELLEN</button>
        <input type="file" id="gate" style="display:none" accept="image/*" onchange="autoFill(event)">

        <button id="final-btn" class="btn-inject" style="background:#ff0055; color:#fff; display:none;" onclick="finalize()">2. DEBIT JETZT VOLLZIEHEN</button>
    </div>

    <script>
        const PHI = 1.61803398875;
        let esi = parseFloat(localStorage.getItem('ESI')) || 10000.0;
        let debitAmount = 0;

        async function autoFill(event) {
            const file = event.target.files[0];
            const led = document.getElementById('led');
            const field = document.getElementById('current-val');
            
            try {
                const data = await Html5Qrcode.scanImage(file, { fps: 60 });
                const match = data.match(/[0-9]+[.,][0-9]2/);
                
                if(match) {
                    const eur = parseFloat(match[0].replace(',', '.'));
                    debitAmount = eur / PHI;
                    
                    // AUTO-AUSFÜLLEN
                    field.value = "BETRAG: " + eur.toFixed(2) + "€ -> " + debitAmount.toFixed(2) + " ESI";
                    led.classList.add('online');
                    document.getElementById('final-btn').style.display = 'block';
                    
                    // GHOST-DELAY ZUM AUTO-FREISCHALTEN
                    setTimeout(() => { document.getElementById('final-btn').click(); }, 3000);
                }
            } catch(e) { alert("Kontakt fehlgeschlagen. Bild-Entropie zu hoch."); }
        }

        function finalize() {
            if(esi >= debitAmount) {
                esi -= debitAmount;
                localStorage.setItem('ESI', esi);
                alert("DEBIT ERFOLGREICH: Deine Wallet-Daten wurden injiziert.");
                location.reload();
            }
        }
    </script>
</body>
</html>