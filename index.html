<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>T-ESOIST | Self-Payment Automaton</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { background: #000; color: #00f2ff; font-family: 'Courier New', monospace; padding: 20px; text-align: center; }
        .automaton-unit { border: 3px solid #00f2ff; padding: 30px; border-radius: 10px; background: rgba(0,242,255,0.05); box-shadow: 0 0 40px #00f2ff; }
        .status-pulse { animation: pulse 2s infinite; color: #00ff00; font-weight: bold; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
        .btn-pay { width: 100%; background: #00f2ff; color: #000; border: none; padding: 25px; font-weight: bold; cursor: pointer; font-size: 20px; border-radius: 15px; }
        .log-box { margin-top: 25px; font-size: 11px; color: #00ff00; text-align: left; background: #0a0a0a; padding: 10px; border: 1px solid #111; height: 120px; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="automaton-unit">
        <h3>SELF-PAYMENT AUTOMATON v90</h3>
        <div id="sync-status" class="status-pulse">WALLET SYNC: ACTIVE</div>
        
        <div id="balance" style="font-size: 28px; margin: 20px 0;">0.00 ESI</div>

        <button class="btn-pay" onclick="document.getElementById('auto-upload').click()">AUTO-BEZAHLUNG STARTEN</button>
        <input type="file" id="auto-upload" style="display:none" accept="image/*" onchange="runAutomaton(event)">
        
        <div id="auto-log" class="log-box">SYSTEM INITIALIZED...</div>
    </div>

    <script>
        const PHI = 1.61803398875;
        let esi = parseFloat(localStorage.getItem('ESI')) || 10000.0;

        function addLog(m) {
            const log = document.getElementById('auto-log');
            log.innerHTML += "> " + m + "<br>";
            log.scrollTop = log.scrollHeight;
        }

        function updateUI() {
            document.getElementById('balance').innerText = esi.toFixed(2) + " ESI";
            localStorage.setItem('ESI', esi);
        }

        async function runAutomaton(event) {
            const file = event.target.files[0];
            addLog("Bild-Input erkannt. Starte Extraktion...");
            
            try {
                const data = await Html5Qrcode.scanImage(file, { fps: 60 });
                addLog("QR-Daten dekodiert.");
                
                const match = data.match(/[0-9]+[.,][0-9]{2}/);
                if(match) {
                    const eur = parseFloat(match[0].replace(',', '.'));
                    const debit = eur / PHI;
                    
                    addLog("Betrag isoliert: " + eur.toFixed(2) + " €");
                    addLog("Umrechnung: " + debit.toFixed(2) + " ESI");
                    
                    if(esi >= debit) {
                        addLog("Guthaben verifiziert. Initiiere Zahlung...");
                        setTimeout(() => {
                            esi -= debit;
                            updateUI();
                            addLog("TRANSFAKTION ERFOLGREICH ABGESCHLOSSEN.");
                            alert("SELBSTBEZAHLUNG ÜBER " + eur.toFixed(2) + "€ VOLLZOGEN.");
                        }, 1000);
                    } else {
                        addLog("FEHLER: Deckung im Gitter unzureichend.");
                    }
                } else {
                    addLog("Mechanischer Fehler: Kein Betrag im Bild.");
                    const manual = prompt("Kein Betrag erkannt. Manuelle Eingabe (€):");
                    if(manual) {
                        const eur = parseFloat(manual.replace(',', '.'));
                        esi -= (eur / PHI);
                        updateUI();
                        addLog("Manuelle Zahlung verbucht.");
                    }
                }
            } catch (e) {
                addLog("Barriere erkannt. Protokoll-Abbruch.");
            }
        }
        updateUI();
    </script>
</body>
</html>