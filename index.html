<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>T-ESOIST | Universal QR Terminal</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { background: #000; color: #00f2ff; font-family: monospace; margin: 0; padding: 15px; text-align: center; }
        .terminal { width: 100%; max-width: 350px; background: rgba(0,242,255,0.05); border: 2px solid #00f2ff; padding: 20px; border-radius: 10px; margin: auto; }
        .btn-action { width: 100%; background: #00f2ff; color: #000; border: none; padding: 15px; font-weight: bold; cursor: pointer; border-radius: 5px; margin-bottom: 10px; }
        .file-input { display: none; }
        input[type="text"], input[type="number"] { width: 100%; background: #000; border: 1px solid #00f2ff; color: #fff; padding: 12px; margin: 8px 0; box-sizing: border-box; }
        #reader { width: 100%; display: none; margin-bottom: 10px; border-radius: 10px; overflow: hidden; }
        .status-msg { font-size: 10px; color: #00ff00; margin-top: 10px; text-transform: uppercase; }
    </style>
</head>
<body>

    <div class="terminal">
        <h3 style="margin: 0;">UNIVERSAL SCANNER</h3>
        <p style="font-size: 10px; color: #888; margin-bottom: 20px;">Live-Scan oder Galerie-Upload</p>
        
        <div id="reader"></div>

        <button class="btn-action" onclick="startLiveScan()">KAMERA STARTEN</button>
        
        <button class="btn-action" style="background: #fff;" onclick="document.getElementById('qr-input-file').click()">AUS GALERIE WÄHLEN</button>
        <input type="file" id="qr-input-file" class="file-input" accept="image/*" onchange="scanFromGallery(event)">

        <div style="border-top: 1px solid #333; margin-top: 20px; padding-top: 15px;">
            <input type="text" id="receiver" placeholder="Empfänger Kontakt">
            <input type="number" id="euro-amount" placeholder="Betrag in €">
            <button class="btn-action" style="background:#ff0055; color:#fff;" onclick="executeTransfer()">ZAHLUNG BESTÄTIGEN</button>
        </div>
        <div id="status" class="status-msg">Bereit zur Analyse</div>
    </div>

    <script>
        const html5QrCode = new Html5Qrcode("reader");
        const PHI = 1.61803398875;
        let esi = parseFloat(localStorage.getItem('ESI')) || 10000.0;

        // Funktion für Galerie-Upload
        function scanFromGallery(event) {
            const file = event.target.files[0];
            if (!file) return;

            document.getElementById('status').innerText = "Analysiere Bild...";
            
            html5QrCode.scanFile(file, true)
                .then(decodedText => {
                    processDecodedData(decodedText);
                })
                .catch(err => {
                    document.getElementById('status').innerText = "KEIN QR-CODE GEFUNDEN";
                    document.getElementById('status').style.color = "#ff0055";
                });
        }

        function startLiveScan() {
            document.getElementById('reader').style.display = 'block';
            html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (text) => {
                processDecodedData(text);
                html5QrCode.stop();
                document.getElementById('reader').style.display = 'none';
            });
        }

        function processDecodedData(data) {
            const parts = data.split('|');
            if (parts[0] === "T-ESOIST") {
                document.getElementById('receiver').value = parts[2];
                document.getElementById('euro-amount').value = parts[3].replace('EUR', '');
                document.getElementById('status').innerText = "VALIDIERT: DATEN AUS GALERIE ÜBERNOMMEN";
                document.getElementById('status').style.color = "#00ff00";
            } else {
                document.getElementById('status').innerText = "UNGÜLTIGES FORMAT";
                document.getElementById('status').style.color = "#ff0055";
            }
        }

        function executeTransfer() {
            const eur = parseFloat(document.getElementById('euro-amount').value);
            const rec = document.getElementById('receiver').value;
            const reqESI = eur / PHI;

            if (eur > 0 && esi >= reqESI) {
                if (confirm(`Sende ${eur}€ an ${rec}?`)) {
                    esi -= reqESI;
                    localStorage.setItem('ESI', esi);
                    alert("TRANSFAKTION ERFOLGREICH VERBUCHT!");
                    location.reload();
                }
            }
        }
    </script>
</body>
</html>