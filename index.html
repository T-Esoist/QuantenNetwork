<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T-ESOIST | Omni-Automation</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { background: #000; color: #00f2ff; font-family: 'Courier New', monospace; padding: 20px; text-align: center; }
        .auto-core { border: 2px solid #00f2ff; padding: 30px; border-radius: 20px; background: rgba(0,242,255,0.05); box-shadow: 0 0 30px #00f2ff; }
        .scanner-active { border: 2px dashed #00ff00; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
        .btn-omni { width: 100%; background: #00f2ff; color: #000; border: none; padding: 20px; font-weight: bold; cursor: pointer; border-radius: 10px; font-size: 18px; }
        #log { margin-top: 20px; font-size: 12px; color: #00ff00; text-align: left; height: 100px; overflow: hidden; }
    </style>
</head>
<body>
    <div class="auto-core">
        <h2 style="letter-spacing: 3px;">OMNI-AUTOMATION v88</h2>
        <div id="status" style="color: #ff0055; margin-bottom: 20px;">SYSTEM: WAITING FOR DATA</div>
        
        <button class="btn-omni" onclick="document.getElementById('upload').click()">AUTO-ABWICKLUNG STARTEN</button>
        <input type="file" id="upload" style="display:none" accept="image/*" onchange="runOmniProcess(event)">
        
        <div id="log"></div>
    </div>

    <script>
        const PHI = 1.61803398875;
        let esi = parseFloat(localStorage.getItem('ESI')) || 10000.0;

        function addLog(msg) {
            const l = document.getElementById('log');
            l.innerHTML += ">> " + msg + "<br>";
        }

        function runOmniProcess(event) {
            const file = event.target.files[0];
            const status = document.getElementById('status');
            
            status.innerText = "PROZESS: AKTIV";
            status.style.color = "#00ff00";
            addLog("Bild geladen...");
            
            Html5Qrcode.scanImage(file, { fps: 30 })
                .then(data => {
                    addLog("QR-Daten isoliert...");
                    const match = data.match(/[0-9]+[.,][0-9]{2}/);
                    const amount = match ? match[0].replace(',', '.') : null;
                    
                    if(amount) {
                        const reqESI = (parseFloat(amount) / PHI).toFixed(2);
                        addLog("Betrag erkannt: " + amount + "€");
                        addLog("Umrechnung: " + reqESI + " ESI");
                        
                        // DIE AUTOMATISIERUNG:
                        setTimeout(() => {
                            esi -= parseFloat(reqESI);
                            localStorage.setItem('ESI', esi);
                            addLog("TRANSFAKTION IM GITTER VERBUCHT.");
                            status.innerText = "ABWICKLUNG ERFOLGREICH";
                            alert("AUTOMATISCHE ZAHLUNG ÜBER " + amount + "€ ABGESCHLOSSEN.");
                            location.reload();
                        }, 1500);
                    } else {
                        addLog("FEHLER: Kein Betrag gefunden.");
                        status.innerText = "ABBRUCH: DATEN UNKLAR";
                        status.style.color = "#ff0055";
                    }
                })
                .catch(err => {
                    addLog("FEHLER: Scan fehlgeschlagen.");
                    status.innerText = "RETRY REQUIRED";
                });
        }
    </script>
    <div id="qr-hidden" style="display:none"></div>
</body>
</html>