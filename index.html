<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>T-ESOIST | Universal Decoder</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { background: #000; color: #00f2ff; font-family: monospace; padding: 15px; text-align: center; }
        .terminal { width: 100%; max-width: 350px; background: rgba(0,242,255,0.05); border: 2px solid #00f2ff; padding: 20px; border-radius: 10px; margin: auto; }
        .btn-action { width: 100%; background: #00f2ff; color: #000; border: none; padding: 15px; font-weight: bold; cursor: pointer; border-radius: 5px; margin-bottom: 10px; }
        input { width: 100%; background: #000; border: 1px solid #00f2ff; color: #fff; padding: 12px; margin: 8px 0; box-sizing: border-box; }
        #status { font-size: 11px; color: #ffaa00; margin-top: 10px; text-transform: uppercase; }
    </style>
</head>
<body>
    <div class="terminal">
        <h3>UNIVERSAL DECODER v83.0</h3>
        <p style="font-size: 10px; color: #888;">Akzeptiert jetzt alle QR-Formate</p>
        
        <button class="btn-action" onclick="document.getElementById('qr-file').click()">BILD AUS GALERIE LADEN</button>
        <input type="file" id="qr-file" style="display:none" accept="image/*" onchange="decodeAnyQR(event)">

        <div style="margin-top: 20px; border-top: 1px solid #333; padding-top: 10px;">
            <input type="text" id="receiver" placeholder="Empfänger (erkannt)">
            <input type="number" id="euro-amount" placeholder="Betrag (€) erkannt">
            <button class="btn-action" style="background:#ff0055; color:#fff;" onclick="executeUniversal()">ZAHLUNG JETZT VERBUCHEN</button>
        </div>
        <div id="status">Warte auf Scan...</div>
    </div>

    <script>
        const html5QrCode = new Html5Qrcode("reader-hidden", false);
        let esi = parseFloat(localStorage.getItem('ESI')) || 10000.0;
        const PHI = 1.61803398875;

        function decodeAnyQR(event) {
            const file = event.target.files[0];
            const status = document.getElementById('status');
            const recField = document.getElementById('receiver');
            const amtField = document.getElementById('euro-amount');

            Html5Qrcode.scanImage(file)
                .then(data => {
                    status.innerText = "CODE ERKANNT. ANALYSIERE...";
                    if (data.startsWith("T-ESOIST")) {
                        const p = data.split('|');
                        recField.value = p[2];
                        amtField.value = p[3].replace('EUR', '');
                        status.innerText = "INTERNER TOKEN VALIDIERT";
                    } else {
                        // EXTERNE LOGIK: Suche nach Zahlen (Beträgen) im Text
                        const amountMatch = data.match(/[0-9]+[.,][0-9]{2}/);
                        if(amountMatch) amtField.value = amountMatch[0].replace(',', '.');
                        recField.value = "Externer Gläubiger/Bank";
                        status.innerText = "EXTERNES FORMAT ÜBERSETZT";
                    }
                    status.style.color = "#00ff00";
                })
                .catch(err => {
                    status.innerText = "FEHLER: CODE NICHT LESBAR";
                    status.style.color = "#ff0055";
                });
        }

        function executeUniversal() {
            const eur = parseFloat(document.getElementById('euro-amount').value);
            const reqESI = eur / PHI;
            if(esi >= reqESI && eur > 0) {
                esi -= reqESI;
                localStorage.setItem('ESI', esi);
                alert("ERFOLG: " + eur + "€ wurden als " + reqESI.toFixed(2) + " ESI verbucht.");
                location.reload();
            } else { alert("Deckung unzureichend!"); }
        }
    </script>
    <div id="reader-hidden" style="display:none"></div>
</body>
</html>