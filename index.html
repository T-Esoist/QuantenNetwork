<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>T-ESOIST | QR-Scanner Terminal</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { background: #000; color: #00f2ff; font-family: monospace; margin: 0; padding: 15px; text-align: center; }
        #reader { width: 100%; max-width: 350px; border: 2px solid #00f2ff; border-radius: 10px; margin: 20px auto; overflow: hidden; background: #111; }
        .terminal { width: 100%; max-width: 350px; background: rgba(0,242,255,0.05); border: 1px solid #00f2ff; padding: 20px; border-radius: 10px; margin: auto; }
        input { width: 100%; background: #000; border: 1px solid #00f2ff; color: #fff; padding: 12px; margin: 8px 0; border-radius: 5px; }
        .btn-scan { width: 100%; background: #00f2ff; color: #000; border: none; padding: 15px; font-weight: bold; cursor: pointer; border-radius: 5px; margin-bottom: 10px; }
        .status-msg { font-size: 10px; color: #00ff00; margin-top: 10px; }
    </style>
</head>
<body>

    <div class="terminal">
        <h3 style="margin: 0;">QR SCANNER TERMINAL</h3>
        <p style="font-size: 10px; color: #888;">Scannen Sie einen T-ESOIST Token für Auto-Transfer</p>
        
        <div id="reader"></div>
        
        <button class="btn-scan" id="start-btn" onclick="startScanner()">KAMERA AKTIVIEREN</button>
        
        <div style="border-top: 1px solid #333; margin-top: 15px; padding-top: 10px;">
            <label style="font-size: 10px; display: block; text-align: left;">EMPFÄNGER:</label>
            <input type="text" id="receiver" placeholder="Wird automatisch gefüllt...">
            <label style="font-size: 10px; display: block; text-align: left;">BETRAG (€):</label>
            <input type="number" id="euro-amount" placeholder="0.00">
            <button class="btn-scan" style="background:#ff0055; color:#fff;" onclick="executeTransfer()">ZAHLUNG BESTÄTIGEN</button>
        </div>
        <div id="status" class="status-msg">READY TO SCAN</div>
    </div>

    <script>
        const html5QrCode = new Html5Qrcode("reader");
        const PHI = 1.61803398875;
        let esi = parseFloat(localStorage.getItem('ESI')) || 10000.0;

        function startScanner() {
            document.getElementById('start-btn').style.display = 'none';
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            
            html5QrCode.start({ facingMode: "environment" }, config, (decodedText) => {
                // Erwartetes Format: T-ESOIST|ID|EMPFÄNGER|BETRAG
                const parts = decodedText.split('|');
                if (parts[0] === "T-ESOIST") {
                    document.getElementById('receiver').value = parts[2];
                    document.getElementById('euro-amount').value = parts[3].replace('EUR', '');
                    document.getElementById('status').innerText = "TOKEN VALIDIERT: DATEN ÜBERNOMMEN";
                    document.getElementById('status').style.color = "#00ff00";
                    // Scanner stoppen nach Erfolg
                    html5QrCode.stop();
                } else {
                    document.getElementById('status').innerText = "UNGÜLTIGER TOKEN";
                    document.getElementById('status').style.color = "#ff0055";
                }
            });
        }

        function executeTransfer() {
            const eur = parseFloat(document.getElementById('euro-amount').value);
            const rec = document.getElementById('receiver').value;
            const reqESI = eur / PHI;

            if (eur > 0 && esi >= reqESI) {
                if (confirm(`Sende ${eur}€ (${reqESI.toFixed(2)} ESI) an ${rec}?`)) {
                    esi -= reqESI;
                    localStorage.setItem('ESI', esi);
                    alert("TRANSFAKTION ERFOLGREICH!");
                    location.reload();
                }
            } else { alert("Fehler: Deckung oder Daten prüfen."); }
        }
    </script>
</body>
</html>